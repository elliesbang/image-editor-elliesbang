export const onRequestPost = async ({ request, env }) => {
  try {
    const { imageBase64 } = await request.json();

    if (!imageBase64) {
      return new Response(
        JSON.stringify({ error: "ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." }),
        { status: 400, headers: { "Content-Type": "application/json" } }
      );
    }

    // Base64 â†’ Binary ë³€í™˜
    const base64Clean = imageBase64.replace(/^data:image\/\w+;base64,/, "");
    const imageBytes = Uint8Array.from(atob(base64Clean), (c) =>
      c.charCodeAt(0)
    );

    // âœ… Hugging Face Florence-2 Auto-Crop ëª¨ë¸ í˜¸ì¶œ
    const response = await fetch(
      "https://api-inference.huggingface.co/models/Wi-zz/florence-2-auto-crop",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${env.HF_API_KEY}`, // Cloudflare Pages í™˜ê²½ ë³€ìˆ˜
          "Content-Type": "application/octet-stream",
        },
        body: imageBytes, // ì´ë¯¸ì§€ ë°”ì´ë„ˆë¦¬ ì§ì ‘ ì „ì†¡
      }
    );

    if (!response.ok) {
      const errText = await response.text();
      throw new Error(
        `í—ˆê¹…í˜ì´ìŠ¤ API ì˜¤ë¥˜ (${response.status}): ${errText}`
      );
    }

    // âœ… í¬ë¡­ëœ ê²°ê³¼ ì´ë¯¸ì§€ ë°›ê¸°
    const croppedImage = await response.arrayBuffer();

    return new Response(croppedImage, {
      headers: { "Content-Type": "image/png" },
    });
  } catch (err) {
    console.error("ğŸš¨ Florence-2 Auto-Crop ì˜¤ë¥˜:", err);
    return new Response(
      JSON.stringify({ error: err.message }),
      {
        status: 500,
        headers: { "Content-Type": "application/json" },
      }
    );
  }
};
